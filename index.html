<!doctype html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="theme-color" content="#4db6ac">
	<title>Configuración Inicial</title>
	<link rel="stylesheet" href="css/materialize.min.css">
	<link href="css/icon.css" rel="stylesheet">
	<style>
	body {
		cursor:default;
		-moz-user-select: -moz-none;
		-khtml-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}

	*:focus {
		outline:none !important;
	}
	
	.hid{
		display: none;
	}

	.container{
		padding-top: 20px;
	}

	div.overlay {
		opacity:    0.5; 
		background: #000; 
		width:      100%;
		height:     100%; 
		z-index:    10;
		top:        0; 
		left:       0; 
		position:   fixed; 
	}
</style>
<script src="js/jquery.js"></script>
<script src="js/materialize.min.js"></script>
</head>
<body>
	<nav>
		<div class="nav-wrapper teal lighten-2">
			<a href="#" class="brand-logo center truncate">Configuración Inicial</a>
		</div>
	</nav>
	<div class="overlay valign-wrapper hid">
		<div class="row">
			<div class="col s12 m12 l12 xl12">
				<div class="preloader-wrapper big active">
					<div class="spinner-layer spinner-blue">
						<div class="circle-clipper left">
							<div class="circle"></div>
						</div><div class="gap-patch">
							<div class="circle"></div>
						</div><div class="circle-clipper right">
							<div class="circle"></div>
						</div>
					</div>

					<div class="spinner-layer spinner-red">
						<div class="circle-clipper left">
							<div class="circle"></div>
						</div><div class="gap-patch">
							<div class="circle"></div>
						</div><div class="circle-clipper right">
							<div class="circle"></div>
						</div>
					</div>

					<div class="spinner-layer spinner-yellow">
						<div class="circle-clipper left">
							<div class="circle"></div>
						</div><div class="gap-patch">
							<div class="circle"></div>
						</div><div class="circle-clipper right">
							<div class="circle"></div>
						</div>
					</div>

					<div class="spinner-layer spinner-green">
						<div class="circle-clipper left">
							<div class="circle"></div>
						</div><div class="gap-patch">
							<div class="circle"></div>
						</div><div class="circle-clipper right">
							<div class="circle"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="container configNetwork" id="ConfigDivNetwork">
		<div class="row">
			<div class="switch col s12 m12 l4 xl4 center-align">
				<p>Tipo de Busqueda Wifi</p>
				<div class="switch">
					<label>Manual<input id="ConfigCheckAutoSSID" checked type="checkbox"><span class="lever"></span>Automatica</label>
				</div>
			</div>
			<div id="ConfigDivAutoSSID" class="input-field col s10 m10 l3 xl3">
				<i class="material-icons prefix">wifi</i>
				<select id="ConfigSelectSSID">
					
				</select>
				<label>Red Wifi</label>
			</div>
			<div id="ConfigDivRefreshSSID" class="input-field col s2 m2 l1 x1">
				<a id="ConfigButtonRefresh" class="btn-floating z-depth-5"><i class="material-icons">autorenew</i></a>
			</div>
			<div id="ConfigDivManualSSID" class="input-field col s12 m12 l4 xl4 hid">
				<i class="material-icons prefix">wifi</i>
				<input type="text" class="validate" required>
				<label>Red Wifi</label>
			</div>
			<div id="ConfidDivPass" class="input-field col s12 m12 l4 xl4 center-align">
				<i class="material-icons prefix">vpn_key</i>
				<input type="text" class="validate" required minlength="8">
				<label>Clave</label>
			</div>
		</div>
		<div class="row">
			<div class="col s12 m12 l12 xl12 center-align">
				<input type="checkbox" id="ConfigCheckDHCP" checked>
				<label for="ConfigCheckDHCP">Obtener parametros de red automaticamente</label>
			</div>
		</div>
		<div class="row hid" id="ConfigDivStatic">
			<div class="input-field col s12 m4 l4 xl4">
				<i class="material-icons prefix">settings_ethernet</i>
				<input type="text" id="ConfigInputIP" pattern="(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*){3}" class="validate" required>
				<label>Ip</label>
			</div>
			<div class="input-field col s12 m4 l4 xl4">
				<i class="material-icons prefix">settings_ethernet</i>
				<input type="text" id="ConfigInputNM" pattern="(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*){3}" class="validate" required>
				<label>Mascara de Subred</label>
			</div>
			<div class="input-field col s12 m4 l4 xl4">
				<i class="material-icons prefix">settings_ethernet</i>
				<input type="text" id="ConfigInputGW" pattern="(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)_*){3}" class="validate" required>
				<label>Puerta de Enlace</label>
			</div>
		</div>
	</div>
	<div class="container configServer hid" id="ConfigDivServer">
		<div class="row">
			<div class="input-field col s12 m6">
				<i class="material-icons prefix">cloud</i>
				<input id="ConfigInputServer" type="text" class="validate" requied pattern="^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$">
				<label for="ConfigInputServer">Servidor</label>
			</div>
			<div class="input-field col s12 m6">
				<i class="material-icons prefix">device_hub</i>
				<input id="ConfigInputPort" type="number" class="validate" min="0" max="65535" requied>
				<label for="ConfigInputPort">Puerto</label>
			</div>
		</div>
		<div class="row">
			<div class="input-field col s12 m4">
				<i class="material-icons prefix">person</i>
				<input id="ConfigInputUser" type="text">
				<label for="ConfigInputUser">Usuario</label>
			</div>
			<div class="input-field col s12 m4">
				<i class="material-icons prefix">vpn_key</i>
				<input id="ConfigInputKey" type="password">
				<label for="ConfigInputKey">Clave</label>
			</div>
			<div class="input-field col s12 m4 ">
				<i class="material-icons prefix">directions</i>
				<input id="ConfigInputTopic" type="text" class="validate" pattern="\w+(\/\w+)*" required placeholder="Casa/Piso1/Dormitorio">
				<label for="ConfigInputTopic">Topico de Mensaje</label>
			</div>
		</div>
	</div>
	<div class="container">
		<div class="row">
			<div class="col s12 m12 l12 xl12 center-align configNetwork">
				<button id="ConfigButtonCheck" class="waves-effect waves-light btn"><i class="material-icons left">rss_feed</i>Comprobar Red</button>
				<button id="ConfigButtonNext" class="waves-effect waves-light btn disabled" disabled><i class="material-icons left">navigate_next</i>Siguiente</button>
			</div>
			<div class="col s12 m12 l12 xl12 center-align configServer hid">
				<button id="ConfigButtonPrev" class="waves-effect waves-light btn"><i class="material-icons left">navigate_before</i>Anterior</button>
				<button id="ConfigButtonSave" class="waves-effect waves-light btn"><i class="material-icons left">done</i>Salvar y Reiniciar</button>
			</div>
			<div class="col s12 m12 l12 xl12 center-align">
				<h5 class="hid">Se ha guardado la configuracion en el dispositivo exitosamente.</h5>
			</div>
		</div>
	</div>
	<script>
		$(document).ready(function() {
			device = "192.168.4.1";

			cargarRedes();

			$(document).on('click', '#ConfigButtonRefresh', function() {
				cargarRedes();
			});

			$(document).on('change', '#ConfigCheckAutoSSID', function(e) {
				if($(this).prop("checked")){
					$("#ConfigDivManualSSID").hide();
					$("#ConfigDivAutoSSID").show();
					$("#ConfigDivRefreshSSID").show();
				}else{
					$("#ConfigDivAutoSSID").hide();
					$("#ConfigDivRefreshSSID").hide();
					$("#ConfigDivManualSSID").show();
				}
			});
			
			$(document).on('change', '#ConfigCheckDHCP', function(e) {
				if($(this).prop("checked")){
					$("#ConfigDivStatic").hide();
				}else{
					$("#ConfigDivStatic").show();
				}
			});

			$(document).on("click", "#ConfigButtonCheck", function(){
				checkNetworking();
			});

			$(document).on("click", "#ConfigButtonSave", function(){
				checkServer();
			});

			$(document).on("click", "#ConfigButtonNext", function(){
				cambioForm(".configNetwork",".configServer");
			});

			$(document).on("click", "#ConfigButtonPrev", function(){
				cambioForm(".configServer", ".configNetwork");
			});
		});

		function cambioForm(hide,show){
			$(hide).hide("slow");
			$(show).show("slow");
		}

		function checkNetworking(){
			if(checkNetworkConfig()){
				var ssid = ($("#ConfigCheckAutoSSID").prop("checked"))?$("#ConfigDivAutoSSID input").val():$("#ConfigDivManualSSID input").val();
				var pass = $("#ConfidDivPass input").val();
				var IP = "";
				var NM = "";
				var GW = "";
				if(!$("#ConfigCheckDHCP").prop("checked")){
					IP = $("#ConfigInputIP").val();
					NM = $("#ConfigInputNM").val();
					GW = $("#ConfigInputGW").val();
				}

				$.ajax({
					url: "http://"+device+"/confInicial",
					dataType: 'json',
					data: {ssid:ssid, pass:pass, ip: IP, nm:NM, gw:GW},
					beforeSend: function(){
						$(".overlay").removeClass('hid');
					},
					success: function(data){
						if(data[0].IP!=""){
							$("#ConfigInputIP").val(data[0].IP);
							$("#ConfigInputNM").val(data[0].NM);
							$("#ConfigInputGW").val(data[0].GW);
							$("#ConfigDivNetwork :input").prop("disabled", true);
							$("#ConfigDivStatic").show();
							$("#ConfigButtonCheck").addClass("disabled");
							$("#ConfigButtonCheck").prop("disabled",true);
							$("#ConfigButtonNext").removeClass("disabled");
							$("#ConfigButtonNext").prop("disabled",false);
							$("#InputLinkRefresh").addClass("disabled");
							$("#InputLinkRefresh").prop("disabled",true);
							toast("Dispositivo configurado exitosamente", 3000);
						}else{
							toast("Error al configurar dispositivo", 3000);
						}

					}
				}).fail(function(){
					toast("Error al enviar configuracion", 3000);
				}).always(function(){
					$(".overlay").addClass("hid");
				});
			}
		}

		function checkNetworkConfig(){
			var complete = false;
			if(!$("#ConfigCheckAutoSSID").prop("checked")){
				$("#ConfigDivManualSSID input").focus().blur();
				if($("#ConfigDivManualSSID input").hasClass("invalid")){
					$("#ConfigDivManualSSID input").focus();
					complete = false;
					return false;
				}
				complete = true;
			}else{
				if($("#ConfigDivAutoSSID input").val() == "Buscando Redes..."){
					toast("Sin red automatica seleccionada", 3000);
					complete = false;
					return false;
				}
				complete = true;
			}

			$("#ConfidDivPass input").focus().blur();
			if($("#ConfidDivPass input").hasClass("invalid")){
				$("#ConfidDivPass input").focus();
				complete = false;
				return false;
			}
			complete = true;

			if(!$("#ConfigCheckDHCP").prop("checked")){
				$("#ConfigDivStatic :input").each(function(i,e){
					$(this).focus().blur();
					if($(this).hasClass("invalid")){
						$(this).focus();
						complete = false;
						return false;
					}
					complete = true;
				});
			}else{
				complete = true;
			}
			return complete;
		}

		function checkServer(){
			if(checkServerConfig()){
				var s = $("#ConfigInputServer").val();
				var p = $("#ConfigInputPort").val();
				var u = $("#ConfigInputUser").val();
				var k = $("#ConfigInputKey").val();
				var t = $("#ConfigInputTopic").val();

				$.ajax({
					url: "http://"+device+"/confServer",
					data: {server:s, port:p, user: u, key:k, topic:t},
					beforeSend: function(){
						$(".overlay").removeClass('hid');
					},
					success: function(data){
						if(data=="true"){
							$("#ConfigDivServer :input").prop("disabled", true);
							$("#ConfigButtonSave").addClass("disabled");
							$("#ConfigButtonSave").prop("disabled",true);
							toast("Configuracion Completa. El dispositivo se reiniciara en 5 segundos", 5000);
						}
					}
				}).fail(function(){
					toast("Error al enviar configuracion", 3000);
				}).always(function(){
					$(".overlay").addClass("hid");
				});
			}
		}

		function checkServerConfig(){
			var complete = false;

			$("#ConfigInputServer").focus().blur();
			if($("#ConfigInputServer").hasClass("invalid") || $("#ConfigInputServer").val() == ""){
				$("#ConfigInputServer").focus();
				complete = false;
				return false;
			}
			complete = true;

			$("#ConfigInputPort").focus().blur();
			if($("#ConfigInputPort").hasClass("invalid") || $("#ConfigInputPort").val() == ""){
				$("#ConfigInputPort").focus();
				complete = false;
				return false;
			}
			complete = true;

			$("#ConfigInputTopic").focus().blur();
			if($("#ConfigInputTopic").hasClass("invalid") || $("#ConfigInputTopic").val() == ""){
				$("#ConfigInputTopic").focus();
				complete = false;
				return false;
			}
			complete = true;

			return complete;
		}

		function cargarRedes(){
			$.ajax({
				url: "http://"+device+"/redes",
				dataType: 'json',
				beforeSend: function(){
					$("#ConfigSelectSSID").html('<option value="0" disabled selected>Buscando Redes...</option>');
					$("#ConfigButtonRefresh").addClass("disabled pulse");
					$('select').material_select();
				},
				success: function(data){
					var icon;
					$("#ConfigSelectSSID").html("");
					$.each(data.Redes, function(i, red){
						icon = (red.RSSI>-60)?"1":(red.RSSI>-70)?"2":(red.RSSI>-80)?"3":"4";
						$("#ConfigSelectSSID").append("<option data-icon=\"img/"+icon+".png\" class=\"right circle\">"+red.SSID+"</option>");
					});
					toast("Redes Cargadas", 3000);
				}
			}).done(function(){
				$("#ConfigLinkWifi").removeClass("disabled");
				$('select').material_select();
			}).fail(function(){
				toast("Error al obtener redes", 3000);
			}).always(function(){
				$("#ConfigButtonRefresh").removeClass("disabled pulse");
			});
		}

		function toast(msj, time){
			Materialize.toast(msj,time);
		}
	</script>
</body>
</html>
